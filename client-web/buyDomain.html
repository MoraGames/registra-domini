<!DOCTYPE html>
<html>
<head>
    <title>Acquista Dominio</title>
</head>
<body data-server-no-reload>
    <nav>
        <a href="index.html">Cerca Dominio</a>
        <a href="mydomain.html">I miei domini</a>
        <a href="login.html">Esci</a>
    </nav>
    <h2>Acquista/Rinnova Dominio</h2>
    <div id="domainDetails"></div>
    <form id="buy-domain-form">
        <!-- nome cognome email li recupero-->
        <input type="hidden" id="domainName" name="domainName">
        <label for="duration">Durata della registrazione (mesi):</label>
        <input type="number" id="duration" name="duration" min="1" max="120" required>
        <br><br>
        <label for="ccNumber">Numero di carta di credito:</label>
        <input type="text" id="ccNumber" name="ccNumber" required>
        <br><br>
        <label for="ccExpiry">Data di scadenza della carta di credito:</label>
        <input type="text" id="ccExpiry" name="ccExpiry" placeholder="MM/YY" required>
        <br><br>
        <label for="ccCVV">CVV:</label>
        <input type="text" id="ccCVV" name="ccCVV" required>
        <br><br>
        <label for="ccHolderName">Nome e cognome dell'intestatario della carta:</label>
        <input type="text" id="ccHolderName" name="ccHolderName" required>
        <br><br>
        <input type="submit" value="Acquista Dominio">
    </form>
    <div id="result"></div>
    <script>
        const API_URI = "http://localhost:8080";

        window.onload = init;
        
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const domainName = urlParams.get('domain');
            const typeOp = urlParams.get('typeOperation');
            if (domainName) {
                document.getElementById('domainName').value = domainName;
            } else {
                document.getElementById('result').innerHTML = '<p>Errore: nome del dominio non trovato.</p>';
            }

            document.getElementById('buy-domain-form').addEventListener('submit', handleBuyDomainForm);
        }

        async function handleBuyDomainForm(event) {//acquista il dominio
            event.preventDefault();
            
            const domainName = document.getElementById('domainName').value;
            const duration = parseInt(document.getElementById('duration').value);
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const ccNumber = document.getElementById('ccNumber').value;
            const ccExpiry = document.getElementById('ccExpiry').value;
            const ccCVV = document.getElementById('ccCVV').value;
            const ccHolderName = document.getElementById('ccHolderName').value;

            const sessionId = localStorage.getItem('sessionId');
            const userData = await getUserData(sessionId);
            const userId = userData ? userData.id : null;

            if (!userId) {
                document.getElementById('result').innerHTML = '<p>Errore: ID utente non trovato.</p>';
                return;
            }

            const requestBody = {
                domainName: domainName,
                requestAction: "ACQUIRED",
                userId: userId,
                monthsDuration: duration
            };

            try {
                const response = await fetch(`${API_URI}/domains/new`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('result').innerHTML = `<p>Acquisto riuscito! Dominio: ${data.domainName}, Scadenza: ${data.expiryDate}</p>`;
                } else {
                    document.getElementById('result').innerHTML = `<p>Errore: ${data.message}</p>`;
                }
            } catch (error) {
                document.getElementById('result').innerHTML = `<p>Errore di connessione al server.</p>`;
            }
        }

        async function getUserData(sessionId) {
            try {
                const response = await fetch(`${API_URI}/users/${sessionId}`);
                if (!response.ok) throw new Error(`Errore nella risposta: ${response.status} ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error(`Impossibile eseguire la richiesta:`, error);
                return null;
            }
        }
    </script>
</body>
</html>
