<!DOCTYPE html>
<html>
	<head>
		<title>Login Users</title>
	</head>
	<body data-server-no-reload>
		<h2>LOGIN</h2>
		<form id="add-user">
			<label for="email">email: </label>
			<input type="email" id="input-email" required>
			<p />
			<label for="password">Password: </label>
			<input type="password" id="input-password" required>
			<p />
			<input type="submit" value="Subscribe!">
		</form>
        <p>Non hai un account? <a href="./register.html">Registrati qui</a></p>
		<script>
			const API_URI = "http://localhost:8080";
            // Funzione per crittografare la password in SHA-256
            async function sha256(message) {
                const msgBuffer = new TextEncoder().encode(message);             
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));            
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); 
                return hashHex;
            }

            // Funzione per gestire il submit del form di login
            async function handleLoginForm(event) {
                
                event.preventDefault(); 

                const email = document.getElementById('input-email').value.trim();
                const password = document.getElementById('input-password').value;

                const hashedPassword = await sha256(password);
                // Costruisci il corpo della richiesta POST
                const requestBody = {
                    email: email,
                    password: hashedPassword
                };
                // Effettua la chiamata GET a /users 
                const endpoint = `${API_URI}/users`;

                try {
                    let response = await fetch(endpoint, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestBody)
                    });
                    console.log(response);
                
                    if (!response.ok) {
                        throw new Error(`Risposta GET "${endpoint}" con errore: ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json();

                    // Gestisce la risposta in base al codice di ritorno
                    if (data.code === "200") {
                         alert("ok");
                        localStorage.setItem('sessionId', data.response.id);//salva id sessione
                        window.location.href = 'index.html'; 

                    } else if (data.code === "400") {
                        alert("Formato della richiesta non corretto.");
                    } else if (data.code === "409") {
                        alert("Email o password potrebbero essere errati.");
                    } else {
                        alert("Errore sconosciuto durante il login.");
                    }
                } catch(error) {
                    onError(`Impossibile eseguire la richiesta GET "${endpoint}"`, error);
                }
            }

            async function init() {
                let form = document.getElementById('add-user');
                form.addEventListener('submit', handleLoginForm);
            }        
                
		</script>
	</body>
</html>